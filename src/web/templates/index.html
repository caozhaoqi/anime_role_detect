<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>è§’è‰²åˆ†ç±»ç³»ç»Ÿ</title>
    <link rel="stylesheet" href="{{ url_for('static', filename='css/style.css') }}">
    <script src="https://cdn.jsdelivr.net/npm/onnxruntime-web@1.14.0/dist/ort.min.js"></script>
    <script src="{{ url_for('static', filename='js/wasm_inference.js') }}"></script>
    <script src="{{ url_for('static', filename='js/user_experience_tracker.js') }}"></script>
</head>
<body>
    <div class="container">
        <h1>ğŸ® è§’è‰²åˆ†ç±»ç³»ç»Ÿ</h1>
        <p style="text-align: center; color: #6c757d;">ä¸Šä¼ å›¾ç‰‡ï¼Œè‡ªåŠ¨è¯†åˆ«æ¸¸æˆè§’è‰²</p>
        
        <!-- é”™è¯¯æ¶ˆæ¯ -->
        {% with messages = get_flashed_messages() %}
            {% if messages %}
                {% for message in messages %}
                    <div class="flash-message">
                        {{ message }}
                    </div>
                {% endfor %}
            {% endif %}
        {% endwith %}
        
        <!-- è®¾å¤‡æ£€æµ‹ç»“æœ -->
        <div id="device-info" class="info-box" style="display: none; margin-bottom: 20px;">
            <h3 style="margin-top: 0; color: #0056b3;">ğŸ“± è®¾å¤‡ä¿¡æ¯</h3>
            <p id="device-details"></p>
            <p id="recommended-mode"></p>
        </div>
        
        <!-- ä¸Šä¼ è¡¨å• -->
        <div class="upload-form">
            <h2>ğŸ“ ä¸Šä¼ å›¾ç‰‡</h2>
            <form method="post" enctype="multipart/form-data" onsubmit="showLoading()">
                <div class="form-group">
                    <label for="file" style="display: block; margin-bottom: 10px; font-weight: 500;">é€‰æ‹©å›¾ç‰‡æ–‡ä»¶:</label>
                    <input type="file" name="file" id="file" accept="image/*" required>
                </div>

                <div class="form-group" style="text-align: left; max-width: 300px; margin: 20px auto; padding: 10px; background-color: #f8f9fa; border-radius: 5px;">
                    <label style="cursor: pointer; display: flex; align-items: center;">
                        <input type="checkbox" name="use_model" value="true" style="margin-right: 10px; width: auto;">
                        <span>ä½¿ç”¨ä¸“ç”¨æ¨¡å‹ (EfficientNet)</span>
                    </label>
                    <p style="font-size: 0.8em; color: #6c757d; margin: 5px 0 0 25px;">
                        é»˜è®¤ä½¿ç”¨é€šç”¨ç´¢å¼• (CLIP)ã€‚å‹¾é€‰åå°†ä½¿ç”¨é’ˆå¯¹ç‰¹å®šæ•°æ®é›†è®­ç»ƒçš„é«˜ç²¾åº¦æ¨¡å‹ã€‚
                    </p>
                </div>

                <div class="form-group" style="text-align: left; max-width: 300px; margin: 20px auto; padding: 10px; background-color: #f8f9fa; border-radius: 5px;">
                    <label style="cursor: pointer; display: flex; align-items: center;">
                        <input type="checkbox" name="use_coreml" value="true" style="margin-right: 10px; width: auto;" id="coreml-checkbox">
                        <span>ä½¿ç”¨ Core ML æ¨¡å‹ (Apple è®¾å¤‡)</span>
                    </label>
                    <p style="font-size: 0.8em; color: #6c757d; margin: 5px 0 0 25px;">
                        åœ¨ Apple è®¾å¤‡ä¸Šä½¿ç”¨ Core ML æ¨¡å‹ï¼Œè·å¾—æ›´å¿«çš„æ¨ç†é€Ÿåº¦ã€‚
                    </p>
                </div>

                <div class="form-group" style="text-align: left; max-width: 300px; margin: 20px auto; padding: 10px; background-color: #f8f9fa; border-radius: 5px;">
                    <label style="cursor: pointer; display: flex; align-items: center;">
                        <input type="checkbox" name="use_wasm" value="true" style="margin-right: 10px; width: auto;" id="wasm-checkbox">
                        <span>ä½¿ç”¨ WebAssembly æ¨¡å‹ (æµè§ˆå™¨ç«¯)</span>
                    </label>
                    <p style="font-size: 0.8em; color: #6c757d; margin: 5px 0 0 25px;">
                        åœ¨æµè§ˆå™¨ä¸­ä½¿ç”¨ WebAssembly è¿›è¡Œæ¨ç†ï¼Œæ— éœ€æœåŠ¡å™¨æ”¯æŒã€‚
                    </p>
                </div>

                <!-- Core ML æ¨¡å‹åŠ è½½çŠ¶æ€ -->
                <div id="coreml-status" style="display: none; margin: 10px auto; padding: 10px; background-color: #e3f2fd; border-radius: 5px; max-width: 300px;">
                    <p style="margin: 0; color: #1976d2;">æ­£åœ¨åŠ è½½ Core ML æ¨¡å‹...</p>
                </div>

                <div class="form-group">
                    <button type="submit">ğŸ” è¯†åˆ«è§’è‰²</button>
                </div>
            </form>
        </div>
        
        <!-- åŠ è½½åŠ¨ç”» -->
        <div id="loading">
            <div class="spinner"></div>
            <p style="margin-top: 15px; color: #555;">æ­£åœ¨åˆ†æå›¾ç‰‡ï¼Œè¯·ç¨å€™...</p>
        </div>
        
        <script>
            // è®¾å¤‡æ£€æµ‹
            function detectDevice() {
                const deviceInfo = {
                    isMobile: /Android|webOS|iPhone|iPad|iPod|BlackBerry|IEMobile|Opera Mini/i.test(navigator.userAgent),
                    isApple: /Macintosh|iPhone|iPad|iPod/i.test(navigator.userAgent),
                    isWindows: /Windows/i.test(navigator.userAgent),
                    isLinux: /Linux/i.test(navigator.userAgent),
                    hasGPU: navigator.gpu !== undefined,
                    hasWebAssembly: typeof WebAssembly !== 'undefined'
                };
                
                return deviceInfo;
            }
            
            // æ˜¾ç¤ºè®¾å¤‡ä¿¡æ¯
            function displayDeviceInfo() {
                const deviceInfo = detectDevice();
                const deviceInfoDiv = document.getElementById('device-info');
                const deviceDetails = document.getElementById('device-details');
                const recommendedMode = document.getElementById('recommended-mode');
                const coremlCheckbox = document.getElementById('coreml-checkbox');
                const wasmCheckbox = document.getElementById('wasm-checkbox');
                
                let deviceText = 'â€¢ è®¾å¤‡ç±»å‹: ';
                if (deviceInfo.isMobile) {
                    deviceText += 'ç§»åŠ¨è®¾å¤‡';
                } else if (deviceInfo.isApple) {
                    deviceText += 'Apple è®¾å¤‡';
                } else if (deviceInfo.isWindows) {
                    deviceText += 'Windows è®¾å¤‡';
                } else if (deviceInfo.isLinux) {
                    deviceText += 'Linux è®¾å¤‡';
                } else {
                    deviceText += 'å…¶ä»–è®¾å¤‡';
                }
                
                deviceText += '<br>â€¢ GPU æ”¯æŒ: ' + (deviceInfo.hasGPU ? 'æ˜¯' : 'å¦');
                deviceText += '<br>â€¢ WebAssembly æ”¯æŒ: ' + (deviceInfo.hasWebAssembly ? 'æ˜¯' : 'å¦');
                
                deviceDetails.innerHTML = deviceText;
                
                // æ¨èæ¨¡å¼
                let recommended = 'â€¢ æ¨èæ¨¡å¼: ';
                if (deviceInfo.isApple) {
                    recommended += 'Core ML æ¨¡å‹ (æ€§èƒ½æœ€ä½³)';
                    coremlCheckbox.checked = true;
                    coremlCheckbox.disabled = false;
                    wasmCheckbox.checked = false;
                    wasmCheckbox.disabled = false;
                } else if (deviceInfo.hasWebAssembly) {
                    recommended += 'WebAssembly æ¨¡å‹ (é€Ÿåº¦è¾ƒå¿«)';
                    coremlCheckbox.checked = false;
                    coremlCheckbox.disabled = true;
                    wasmCheckbox.checked = true;
                    wasmCheckbox.disabled = false;
                } else {
                    recommended += 'æœåŠ¡å™¨ç«¯æ¨¡å‹ (å…¼å®¹æ€§æœ€ä½³)';
                    coremlCheckbox.checked = false;
                    coremlCheckbox.disabled = true;
                    wasmCheckbox.checked = false;
                    wasmCheckbox.disabled = true;
                }
                
                recommendedMode.innerHTML = recommended;
                deviceInfoDiv.style.display = 'block';
            }
            
            // WebAssemblyæ¨ç†
            let wasmInference = null;
            let classMapping = null;
            
            // åˆå§‹åŒ–ç”¨æˆ·ä½“éªŒè¿½è¸ªå™¨
            let userExperienceTracker = new UserExperienceTracker();
            
            async function initializeWasm() {
                try {
                    wasmInference = new WasmInference();
                    
                    const modelPath = '/static/models/character_classifier_best_improved.onnx';
                    await wasmInference.initialize(modelPath);
                    
                    const mappingPath = '/static/models/character_classifier_best_improved_class_mapping.json';
                    classMapping = await wasmInference.loadClassMapping(mappingPath);
                    
                    console.log('WebAssemblyæ¨¡å‹åˆå§‹åŒ–æˆåŠŸ');
                    return true;
                } catch (error) {
                    console.error('WebAssemblyæ¨¡å‹åˆå§‹åŒ–å¤±è´¥:', error);
                    return false;
                }
            }
            
            async function classifyWithWasm(file) {
                if (!wasmInference || !wasmInference.isInitialized) {
                    throw new Error('WebAssemblyæ¨¡å‹æœªåˆå§‹åŒ–');
                }
                
                return new Promise((resolve, reject) => {
                    const reader = new FileReader();
                    reader.onload = async (e) => {
                        const img = new Image();
                        img.onload = async () => {
                            try {
                                const predictions = await wasmInference.classifyImage(img);
                                resolve(predictions);
                            } catch (error) {
                                reject(error);
                            }
                        };
                        img.onerror = () => reject(new Error('å›¾åƒåŠ è½½å¤±è´¥'));
                        img.src = e.target.result;
                    };
                    reader.onerror = () => reject(new Error('æ–‡ä»¶è¯»å–å¤±è´¥'));
                    reader.readAsDataURL(file);
                });
            }
            
            // é¡µé¢åŠ è½½æ—¶æ£€æµ‹è®¾å¤‡
            window.onload = function() {
                displayDeviceInfo();
                
                // æ£€æµ‹WebAssemblyæ”¯æŒ
                const wasmCheckbox = document.getElementById('wasm-checkbox');
                if (typeof WebAssembly === 'undefined') {
                    wasmCheckbox.disabled = true;
                    wasmCheckbox.parentElement.style.opacity = '0.5';
                }
            };
            
            function showLoading() {
                document.getElementById('loading').style.display = 'block';
                // ç¦ç”¨æäº¤æŒ‰é’®
                document.querySelector('button[type="submit"]').disabled = true;
            }
        </script>

        <!-- ç³»ç»Ÿä¿¡æ¯ -->
        <div class="info-box">
            <h3 style="margin-top: 0; color: #0056b3;">â„¹ï¸ ç³»ç»Ÿä¿¡æ¯</h3>
            <p>â€¢ æ”¯æŒçš„æ–‡ä»¶æ ¼å¼: PNG, JPG, JPEG, GIF, BMP</p>
            <p>â€¢ æœ€å¤§æ–‡ä»¶å¤§å°: 16MB</p>
            <p>â€¢ è¯†åˆ«æ¨¡å¼: é€šç”¨ç´¢å¼• (CLIP) / ä¸“ç”¨æ¨¡å‹ (EfficientNet) / Core ML æ¨¡å‹ (Apple è®¾å¤‡)</p>
        </div>
        
        <!-- å¿«é€Ÿé“¾æ¥ -->
        <div class="footer">
            <p><a href="/about">å…³äºç³»ç»Ÿ</a> | <a href="/workflow">è§’è‰²æ£€æµ‹å·¥ä½œæµ</a> | <a href="/api/classify">APIæ–‡æ¡£</a></p>
            <p>Â© 2026 è§’è‰²åˆ†ç±»ç³»ç»Ÿ</p>
        </div>
    </div>
</body>
</html>
