<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>æ€§èƒ½ç›‘æ§ä»ªè¡¨æ¿</title>
    <link rel="stylesheet" href="{{ url_for('static', filename='css/style.css') }}">
    <style>
        .monitoring-container {
            max-width: 1200px;
            margin: 0 auto;
            padding: 20px;
        }
        
        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
        }
        
        .stat-card {
            background: white;
            border-radius: 8px;
            padding: 20px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }
        
        .stat-card h3 {
            margin-top: 0;
            color: #0056b3;
            font-size: 1.2em;
        }
        
        .stat-value {
            font-size: 2em;
            font-weight: bold;
            color: #333;
            margin: 10px 0;
        }
        
        .stat-label {
            color: #666;
            font-size: 0.9em;
        }
        
        .chart-container {
            background: white;
            border-radius: 8px;
            padding: 20px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
            margin-bottom: 20px;
        }
        
        .chart-container h3 {
            margin-top: 0;
            color: #0056b3;
        }
        
        .performance-table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 10px;
        }
        
        .performance-table th,
        .performance-table td {
            padding: 12px;
            text-align: left;
            border-bottom: 1px solid #ddd;
        }
        
        .performance-table th {
            background-color: #0056b3;
            color: white;
        }
        
        .performance-table tr:hover {
            background-color: #f5f5f5;
        }
        
        .mode-badge {
            display: inline-block;
            padding: 4px 8px;
            border-radius: 4px;
            font-size: 0.85em;
            font-weight: bold;
        }
        
        .mode-coreml {
            background-color: #4CAF50;
            color: white;
        }
        
        .mode-onnx {
            background-color: #2196F3;
            color: white;
        }
        
        .mode-pytorch {
            background-color: #FF9800;
            color: white;
        }
        
        .mode-clip {
            background-color: #9C27B0;
            color: white;
        }
        
        .success {
            color: #4CAF50;
        }
        
        .error {
            color: #F44336;
        }
        
        .refresh-button {
            background-color: #0056b3;
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 4px;
            cursor: pointer;
            font-size: 1em;
            margin-bottom: 20px;
        }
        
        .refresh-button:hover {
            background-color: #004494;
        }
    </style>
</head>
<body>
    <div class="monitoring-container">
        <h1>ğŸ“Š æ€§èƒ½ç›‘æ§ä»ªè¡¨æ¿</h1>
        <p>å®æ—¶ç›‘æ§ç³»ç»Ÿæ€§èƒ½å’Œç”¨æˆ·ä½“éªŒæ•°æ®</p>
        
        <button class="refresh-button" onclick="refreshData()">ğŸ”„ åˆ·æ–°æ•°æ®</button>
        
        <!-- ç»Ÿè®¡å¡ç‰‡ -->
        <div class="stats-grid">
            <div class="stat-card">
                <h3>æ€»æ¨ç†æ¬¡æ•°</h3>
                <div class="stat-value" id="total-inferences">0</div>
                <div class="stat-label">æ‰€æœ‰æ¨¡å¼ç´¯è®¡</div>
            </div>
            
            <div class="stat-card">
                <h3>æˆåŠŸç‡</h3>
                <div class="stat-value" id="success-rate">0%</div>
                <div class="stat-label">æ¨ç†æˆåŠŸç‡</div>
            </div>
            
            <div class="stat-card">
                <h3>å¹³å‡æ¨ç†æ—¶é—´</h3>
                <div class="stat-value" id="avg-inference-time">0ms</div>
                <div class="stat-label">æ‰€æœ‰æ¨¡å¼å¹³å‡</div>
            </div>
            
            <div class="stat-card">
                <h3>æ´»è·ƒè®¾å¤‡æ•°</h3>
                <div class="stat-value" id="active-devices">0</div>
                <div class="stat-label">ä¸åŒè®¾å¤‡ç±»å‹</div>
            </div>
        </div>
        
        <!-- æ¨¡å¼æ€§èƒ½å¯¹æ¯” -->
        <div class="chart-container">
            <h3>ğŸ“ˆ æ¨ç†æ¨¡å¼æ€§èƒ½å¯¹æ¯”</h3>
            <table class="performance-table">
                <thead>
                    <tr>
                        <th>æ¨ç†æ¨¡å¼</th>
                        <th>æ¨ç†æ¬¡æ•°</th>
                        <th>å¹³å‡æ—¶é—´</th>
                        <th>å æ¯”</th>
                    </tr>
                </thead>
                <tbody id="mode-performance-table">
                    <tr>
                        <td colspan="4" style="text-align: center;">æš‚æ— æ•°æ®</td>
                    </tr>
                </tbody>
            </table>
        </div>
        
        <!-- è®¾å¤‡åˆ†å¸ƒ -->
        <div class="chart-container">
            <h3>ğŸ“± è®¾å¤‡ç±»å‹åˆ†å¸ƒ</h3>
            <table class="performance-table">
                <thead>
                    <tr>
                        <th>è®¾å¤‡ç±»å‹</th>
                        <th>ä½¿ç”¨æ¬¡æ•°</th>
                        <th>å æ¯”</th>
                    </tr>
                </thead>
                <tbody id="device-distribution-table">
                    <tr>
                        <td colspan="3" style="text-align: center;">æš‚æ— æ•°æ®</td>
                    </tr>
                </tbody>
            </table>
        </div>
        
        <!-- æœ€è¿‘æ¨ç†è®°å½• -->
        <div class="chart-container">
            <h3>ğŸ“‹ æœ€è¿‘æ¨ç†è®°å½•</h3>
            <table class="performance-table">
                <thead>
                    <tr>
                        <th>æ—¶é—´</th>
                        <th>æ¨¡å¼</th>
                        <th>æ¨ç†æ—¶é—´</th>
                        <th>çŠ¶æ€</th>
                        <th>è®¾å¤‡ç±»å‹</th>
                    </tr>
                </thead>
                <tbody id="recent-inferences-table">
                    <tr>
                        <td colspan="5" style="text-align: center;">æš‚æ— æ•°æ®</td>
                    </tr>
                </tbody>
            </table>
        </div>
        
        <!-- å¿«é€Ÿé“¾æ¥ -->
        <div class="footer">
            <p><a href="/">è¿”å›é¦–é¡µ</a> | <a href="/about">å…³äºç³»ç»Ÿ</a></p>
            <p>Â© 2026 è§’è‰²åˆ†ç±»ç³»ç»Ÿ - æ€§èƒ½ç›‘æ§</p>
        </div>
    </div>
    
    <script>
        function refreshData() {
            loadStatistics();
            loadRecentInferences();
        }
        
        function loadStatistics() {
            try {
                const records = JSON.parse(localStorage.getItem('inference_records') || '[]');
                
                if (records.length === 0) {
                    return;
                }
                
                const stats = {
                    totalInferences: records.length,
                    byMode: {},
                    averageTimes: {},
                    successCount: 0,
                    deviceTypes: {}
                };
                
                records.forEach(record => {
                    const mode = record.inferenceMode;
                    const time = record.inferenceTime;
                    const deviceType = record.deviceInfo.isApple ? 'Apple' :
                                      record.deviceInfo.isMobile ? 'Mobile' :
                                      record.deviceInfo.isWindows ? 'Windows' :
                                      record.deviceInfo.isLinux ? 'Linux' : 'Other';
                    
                    // æŒ‰æ¨¡å¼ç»Ÿè®¡
                    if (!stats.byMode[mode]) {
                        stats.byMode[mode] = 0;
                    }
                    stats.byMode[mode]++;
                    
                    // æŒ‰è®¾å¤‡ç±»å‹ç»Ÿè®¡
                    if (!stats.deviceTypes[deviceType]) {
                        stats.deviceTypes[deviceType] = 0;
                    }
                    stats.deviceTypes[deviceType]++;
                    
                    // è®¡ç®—å¹³å‡æ—¶é—´
                    if (!stats.averageTimes[mode]) {
                        stats.averageTimes[mode] = { total: 0, count: 0 };
                    }
                    stats.averageTimes[mode].total += time;
                    stats.averageTimes[mode].count++;
                    
                    // æˆåŠŸç‡
                    if (record.success) {
                        stats.successCount++;
                    }
                });
                
                // è®¡ç®—å¹³å‡æ—¶é—´
                Object.keys(stats.averageTimes).forEach(mode => {
                    const data = stats.averageTimes[mode];
                    stats.averageTimes[mode] = data.total / data.count;
                });
                
                // æ›´æ–°ç»Ÿè®¡å¡ç‰‡
                document.getElementById('total-inferences').textContent = stats.totalInferences;
                document.getElementById('success-rate').textContent = 
                    ((stats.successCount / stats.totalInferences) * 100).toFixed(1) + '%';
                
                const totalTime = records.reduce((sum, r) => sum + r.inferenceTime, 0);
                document.getElementById('avg-inference-time').textContent = 
                    (totalTime / stats.totalInferences).toFixed(2) + 'ms';
                
                document.getElementById('active-devices').textContent = 
                    Object.keys(stats.deviceTypes).length;
                
                // æ›´æ–°æ¨¡å¼æ€§èƒ½è¡¨
                updateModePerformanceTable(stats);
                
                // æ›´æ–°è®¾å¤‡åˆ†å¸ƒè¡¨
                updateDeviceDistributionTable(stats);
                
            } catch (e) {
                console.error('åŠ è½½ç»Ÿè®¡æ•°æ®å¤±è´¥:', e);
            }
        }
        
        function updateModePerformanceTable(stats) {
            const tbody = document.getElementById('mode-performance-table');
            const total = stats.totalInferences;
            
            let html = '';
            
            const modeOrder = ['Core ML', 'ONNX', 'PyTorch', 'CLIP'];
            
            modeOrder.forEach(mode => {
                if (stats.byMode[mode]) {
                    const count = stats.byMode[mode];
                    const avgTime = stats.averageTimes[mode].toFixed(2);
                    const percentage = ((count / total) * 100).toFixed(1);
                    
                    const modeClass = mode === 'Core ML' ? 'mode-coreml' :
                                    mode === 'ONNX' ? 'mode-onnx' :
                                    mode === 'PyTorch' ? 'mode-pytorch' : 'mode-clip';
                    
                    html += `
                        <tr>
                            <td><span class="mode-badge ${modeClass}">${mode}</span></td>
                            <td>${count}</td>
                            <td>${avgTime}ms</td>
                            <td>${percentage}%</td>
                        </tr>
                    `;
                }
            });
            
            tbody.innerHTML = html || '<tr><td colspan="4" style="text-align: center;">æš‚æ— æ•°æ®</td></tr>';
        }
        
        function updateDeviceDistributionTable(stats) {
            const tbody = document.getElementById('device-distribution-table');
            const total = stats.totalInferences;
            
            let html = '';
            
            Object.keys(stats.deviceTypes).forEach(deviceType => {
                const count = stats.deviceTypes[deviceType];
                const percentage = ((count / total) * 100).toFixed(1);
                
                html += `
                    <tr>
                        <td>${deviceType}</td>
                        <td>${count}</td>
                        <td>${percentage}%</td>
                    </tr>
                `;
            });
            
            tbody.innerHTML = html || '<tr><td colspan="3" style="text-align: center;">æš‚æ— æ•°æ®</td></tr>';
        }
        
        function loadRecentInferences() {
            try {
                const records = JSON.parse(localStorage.getItem('inference_records') || '[]');
                
                const tbody = document.getElementById('recent-inferences-table');
                
                if (records.length === 0) {
                    tbody.innerHTML = '<tr><td colspan="5" style="text-align: center;">æš‚æ— æ•°æ®</td></tr>';
                    return;
                }
                
                const recentRecords = records.slice(-10).reverse();
                
                let html = '';
                
                recentRecords.forEach(record => {
                    const date = new Date(record.timestamp);
                    const timeStr = date.toLocaleString('zh-CN');
                    
                    const modeClass = record.inferenceMode === 'Core ML' ? 'mode-coreml' :
                                    record.inferenceMode === 'ONNX' ? 'mode-onnx' :
                                    record.inferenceMode === 'PyTorch' ? 'mode-pytorch' : 'mode-clip';
                    
                    const statusClass = record.success ? 'success' : 'error';
                    const statusText = record.success ? 'æˆåŠŸ' : 'å¤±è´¥';
                    
                    const deviceType = record.deviceInfo.isApple ? 'Apple' :
                                      record.deviceInfo.isMobile ? 'Mobile' :
                                      record.deviceInfo.isWindows ? 'Windows' :
                                      record.deviceInfo.isLinux ? 'Linux' : 'Other';
                    
                    html += `
                        <tr>
                            <td>${timeStr}</td>
                            <td><span class="mode-badge ${modeClass}">${record.inferenceMode}</span></td>
                            <td>${record.inferenceTime.toFixed(2)}ms</td>
                            <td class="${statusClass}">${statusText}</td>
                            <td>${deviceType}</td>
                        </tr>
                    `;
                });
                
                tbody.innerHTML = html;
                
            } catch (e) {
                console.error('åŠ è½½æœ€è¿‘è®°å½•å¤±è´¥:', e);
            }
        }
        
        // é¡µé¢åŠ è½½æ—¶åŠ è½½æ•°æ®
        window.onload = function() {
            refreshData();
            
            // æ¯30ç§’è‡ªåŠ¨åˆ·æ–°
            setInterval(refreshData, 30000);
        };
    </script>
</body>
</html>
